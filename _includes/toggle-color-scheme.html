{% capture btn_aria_label %}
  {%- if site.color_scheme == 'dark' -%}
  Switch to Light Mode
  {%- else -%}
  Switch to Dark Mode
  {%- endif -%}
{% endcapture %}

<span class="fs-3">
  <button type="button"
    class="btn js-toggle-dark-mode btn-outline"
    style="margin-right: -3px; border-top-right-radius: 0; border-bottom-right-radius: 0;"
    aria-label="{{ btn_aria_label }}">
    {%- if site.color_scheme == 'dark' -%}
    ðŸ”† Light Mode
    {%- else -%}
    ðŸŒ™ Dark Mode
    {%- endif -%}
  </button>
  <button type="button"
    class="btn js-unset-color-scheme btn-outline px-2"
    style="margin-left: -3px; border-top-left-radius: 0; border-bottom-left-radius: 0;"
    aria-label="Automatically switch theme"
    ><i class="fa-solid fa-rotate" title="Automatically switch theme"></i></button>
</span>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    if (!jtd) { return; }

    const toggleSchemeBtn = document.querySelector('.js-toggle-dark-mode');
    const unsetColorScheme = document.querySelector('.js-unset-color-scheme');
    
    const logoDiv = document.querySelector('.site-logo');
    const logoUrlLight = "{{ site.logo | relative_url }}";
    const logoUrlDark = "{{ site.logo_dark | default: site.logo | relative_url }}";

    // 1. Capture the setting from _config.yml
    const configTheme = "{{ site.color_scheme | default: 'light' }}";

    function setLogo(theme) {
      if (!logoDiv) return;
      if (theme === 'dark') {
        logoDiv.style.backgroundImage = "url('" + logoUrlDark + "')";
      } else {
        logoDiv.style.backgroundImage = "url('" + logoUrlLight + "')";
      }
    }

    function updateButtonText(theme) {
      if (theme === 'dark') {
        toggleSchemeBtn.textContent = 'ðŸ”† Light Mode';
        toggleSchemeBtn.ariaLabel = 'Switch to Light Mode';
      } else {
        toggleSchemeBtn.textContent = 'ðŸŒ™ Dark Mode';
        toggleSchemeBtn.ariaLabel = 'Switch to Dark Mode';
      }
    }

    // 2. LOGIC: Check LocalStorage first. If empty, use _config.yml
    if (localStorage['jtd-theme']) {
      // User has visited before and set a preference
      const savedTheme = localStorage['jtd-theme'];
      jtd.setTheme(savedTheme);
      setLogo(savedTheme);
      updateButtonText(savedTheme);
    } else {
      // New visitor: Ignore OS settings, force the Config default
      jtd.setTheme(configTheme);
      setLogo(configTheme);
      updateButtonText(configTheme);
    }

    // 3. Handle Toggle Click
    jtd.addEvent(toggleSchemeBtn, 'click', function() {
      if (jtd.getTheme() === 'dark') {
        localStorage['jtd-theme'] = 'light';
        jtd.setTheme('light');
        setLogo('light');
        updateButtonText('light');
      } else {
        jtd.setTheme('dark');
        localStorage['jtd-theme'] = 'dark';
        setLogo('dark');
        updateButtonText('dark');
      }
    });

    // 4. Handle Reset Button
    jtd.addEvent(unsetColorScheme, 'click', function() {
      delete localStorage['jtd-theme'];
      
      // When resetting, go back to the Config default
      jtd.setTheme(configTheme);
      setLogo(configTheme);
      updateButtonText(configTheme);
    });
  });
</script>